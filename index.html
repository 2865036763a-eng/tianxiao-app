<!DOCTYPE html>
<html><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="å¤©ç¬‘ç§˜å¯†åŸºåœ°">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#ff6699">
    <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIuWkqeesuOOBrue6geWvhuWfuuWcsyIsCiAgInNob3J0X25hbWUiOiAi5aSp56yY5Z+65ZywIiwKICAic3RhcnRfdXJsIjogIi4vIiwKICAiZGlzcGxheSI6ICJzdGFuZGFsb25lIiwKICAiYmFja2dyb3VuZF9jb2xvciI6ICIjZmZmZmZmIiwKICAidGhlbWVfY29sb3IiOiAiI2ZmNjY5OSIsCiAgImRlc2NyaXB0aW9uIjogIuWkqeesuOOBrue6geWvhuWfuuWcsyAtIOa4uOaIj+S4k+WxnuWIhuS6q+W5s+WPsCIsCiAgIm9yaWVudGF0aW9uIjogInBvcnRyYWl0IiwKICAiaWNvbnMiOiBbCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sO2Jhc2U2NCxQSE4yWnlCNGJXeHVjejBpYUhSMGNEb3ZMM2QzZHk1M015NXZjbWN2TWpBd01DOXpkbWNpSUhkcFpIUm9QU0l4TWpnaUlHaGxhV2RvZEQwaU1USTRJajQ4Y21WamRDQjNhV1IwYUQwaU1USTRJaUJvWldsbmFIUTlJakV5T0NJZ2NuZzlJakl3SWlCbWFXeHNQU0lqWm1ZMk5qazVJaTgrUEM5eVpXTjBQangwWlhoMElIZzlJall5SWlCNVBTSTJOQ0lnWm05dWRDMXphWHBsUFNJME1DSWdabWxzYkQwaUkyWm1abVptWmlJK/CfjIY8TDNSbGVIUStQQzl6ZG1jKyIsCiAgICAgICJzaXplcyI6ICIxMjh4MTI4IiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIsCiAgICAgICJwdXJwb3NlIjogImFueSBtYXNrYWJsZSIKICAgIH0KICBdCn0=">
    <link rel="apple-touch-icon" href="data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSIxMjgiIGhlaWdodD0iMTI4Ij48cmVjdCB3aWR0aD0iMTI4IiBoZWlnaHQ9IjEyOCIgcng9IjIwIiBmaWxsPSIjZmY2Njk5Ii8+PHRleHQgeD0iNjQiIHk9IjcwIiBmb250LXNpemU9IjUwIiBmaWxsPSIjZmZmZmZmIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBkb21pbmFudC1iYXNlbGluZT0ibWlkZGxlIj7wn4yGPC90ZXh0Pjwvc3ZnPg==">
    <title>å¤©ç¬‘ã®ç§˜å¯†åŸºåœ°</title>
    <style>
        :root { --primary: #ff6699; --bg: #f4f5f7; --card: #ffffff; --text: #222; --border: #e3e8ec; --video: #fb7299; --notice: #ff9800; }
        html, body { height: 100%; margin: 0; padding: 0; overscroll-behavior: none; overscroll-behavior-y: none; }
        body { background: var(--bg); color: var(--text); font-family: -apple-system, system-ui, sans-serif; display: flex; flex-direction: column; overflow: hidden; overscroll-behavior: none; }
        
        #gateKeeper { position: fixed; inset: 0; background: #fff; z-index: 2000; display: flex; align-items: center; justify-content: center; flex-direction: column; padding: 20px; text-align: center; }
        .gate-box { max-width: 400px; width: 100%; }
        .disclaimer { font-size: 12px; color: #999; background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; line-height: 1.6; border: 1px dashed #ddd; }
        .gate-input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #ddd; margin-bottom: 15px; outline: none; text-align: center; font-size: 16px; box-sizing: border-box; }
        .gate-btn { width: 100%; padding: 12px; background: var(--primary); color: #fff; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; touch-action: manipulation; }

        header { flex-shrink: 0; padding: 12px 15px; background: var(--card); border-bottom: 1px solid var(--border); z-index: 100; position: relative; }
        .header-top { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .site-title { font-size: 18px; font-weight: bold; color: var(--primary); flex: 1; text-align: center; margin-left: 30px; }
        .login-icon { font-size: 18px; cursor: pointer; color: #ccc; padding: 5px; touch-action: manipulation; }

        #search { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid #ddd; background: #f9f9f9; outline: none; box-sizing: border-box; margin-bottom: 10px; touch-action: manipulation; }
        
        #nav { display: flex; overflow-x: auto; gap: 10px; padding-bottom: 5px; scrollbar-width: none; -webkit-overflow-scrolling: touch; }
        #nav::-webkit-scrollbar { display: none; }
        #nav li { list-style: none; padding: 7px 18px; background: #eee; border-radius: 20px; font-size: 13px; white-space: nowrap; cursor: pointer; color: #555; transition: 0.3s; touch-action: manipulation; }
        #nav li.active { background: var(--primary); color: #fff; font-weight: 500; }
        
        #nav li.notice-tab { background: #fff8e1; color: var(--notice); border: 1px solid var(--notice); }
        #nav li.notice-tab.active { background: var(--notice); color: #fff; }
        
        #nav li.favorite-tab { background: #ffe4f0; color: #ff1493; border: 1px solid #ff69b4; }
        #nav li.favorite-tab.active { background: #ff1493; color: #fff; }

        main { flex: 1; overflow-y: auto; padding: 12px; scroll-behavior: smooth; position: relative; -webkit-overflow-scrolling: touch; overscroll-behavior: contain; overscroll-behavior-y: contain; touch-action: pan-y; }
        /* âœ¨ å…³é”®ä¿®å¤ï¼šç»™ grid å¼€å¯å¼¹æ€§å¸ƒå±€ä»¥æ”¯æŒ order æ’åº */
        .grid { display: flex; flex-direction: column; gap: 20px; max-width: 550px; margin: 0 auto; }
        
        .card { background: var(--card); border-radius: 12px; overflow: hidden; display: none; flex-direction: column; position: relative; border: 1px solid var(--border); box-shadow: 0 4px 15px rgba(0,0,0,0.05); }
        .card.active-render { display: flex; } 

        /* âœ¨ æ ·å¼å±‚ä¸å†ç›´æ¥å†™ orderï¼Œäº¤ç»™ JS åŠ¨æ€åˆ†é… */
        .card.is-pinned { border: 2px solid var(--notice); }
        .card.is-pinned::before { content: "ğŸ“Œ ç½®é¡¶"; position: absolute; top: 10px; right: 80px; background: var(--notice); color: #fff; font-size: 10px; padding: 2px 6px; border-radius: 4px; z-index: 10; font-weight: bold; }

        .slider-box { width: 100%; aspect-ratio: 16 / 9; background: #e0e0e0; position: relative; display: flex; align-items: center; justify-content: center; overflow: hidden; flex-shrink: 0; touch-action: pan-y pinch-zoom; }
        .slider-box img { width: 100%; height: 100%; display: none; object-fit: cover; background: #000; }
        .slider-box img.active { display: block; }
        
        .edit-img-btn { position: absolute; z-index: 15; background: var(--primary); color: #fff; padding: 8px 16px; border-radius: 20px; font-size: 13px; cursor: pointer; display: none; border: none; font-weight: bold; touch-action: manipulation; }
        .admin-mode .edit-img-btn { display: block; }

        .slide-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(0,0,0,0.4); color: #fff; border: none; width: 40px; height: 50px; cursor: pointer; font-size: 24px; z-index: 5; touch-action: manipulation; }
        .prev { left: 0; border-radius: 0 8px 8px 0; }
        .next { right: 0; border-radius: 8px 0 0 8px; }
        .img-index { position: absolute; bottom: 10px; right: 12px; background: rgba(0,0,0,0.6); color: #fff; padding: 3px 10px; border-radius: 12px; font-size: 11px; z-index: 4; }

        .info-box { padding: 15px; display: flex; flex-direction: column; background: #fff; }
        .g-name { font-size: 17px; font-weight: bold; line-height: 1.4; margin-bottom: 8px; color: #111; outline: none; }
        .g-tags { font-size: 12px; color: var(--primary); margin-bottom: 12px; outline: none; }

        .link-wrap { position: relative; background: #f8f9fb; border-radius: 8px; border: 1px solid #edf0f5; display: flex; flex-direction: column; }
        .link-text { font-size: 13px; padding: 12px; color: #333; word-break: break-all; line-height: 1.5; outline: none; display: -webkit-box; -webkit-box-orient: vertical; -webkit-line-clamp: 2; overflow: hidden; }
        .expanded .link-text { -webkit-line-clamp: initial; display: block; overflow-y: auto; max-height: 300px; color: #333; }
        .link-actions { display: flex; gap: 8px; padding: 8px 12px; border-top: 1px solid rgba(0,0,0,0.03); }
        .link-jump-btn { flex: 1; padding: 8px; background: #007bff; color: #fff; border: none; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; transition: 0.2s; touch-action: manipulation; }
        .link-jump-btn:hover { background: #0056b3; }
        .link-jump-btn:active { transform: scale(0.95); }
        .admin-mode .link-jump-btn { display: none; }
        .expand-btn { text-align: right; padding: 5px 12px; font-size: 11px; color: var(--primary); cursor: pointer; border-top: 1px solid rgba(0,0,0,0.03); touch-action: manipulation; }

        /* ä¿®å¤ï¼šç®¡ç†å‘˜æ¨¡å¼ä¸‹æ˜¾ç¤ºå±•å¼€/æ”¶èµ·æŒ‰é’®ï¼ˆå·²åˆ é™¤éšè—è§„åˆ™ï¼‰ */

        .pagination { display: flex; flex-direction: column; align-items: center; gap: 12px; margin: 20px 0; padding: 0 10px 80px 10px; }
        .page-numbers { display: flex; align-items: center; justify-content: center; gap: 8px; flex-wrap: wrap; }
        .page-item { min-width: 38px; height: 38px; border: 1px solid var(--border); background: #fff; color: #666; display: flex; align-items: center; justify-content: center; border-radius: 10px; cursor: pointer; font-size: 14px; transition: 0.2s; touch-action: manipulation; }
        .page-item.active { background: var(--primary); color: #fff; border-color: var(--primary); font-weight: bold; box-shadow: 0 4px 10px rgba(255,102,153,0.3); }
        .page-dot { color: #ccc; }

        .page-jump-row { display: flex; align-items: center; gap: 10px; color: #999; font-size: 13px; flex-wrap: wrap; justify-content: center; }
        .page-jump { width: 90px; height: 36px; border: 1px solid var(--border); border-radius: 8px; padding: 0 10px; font-size: 13px; outline: none; text-align: center; touch-action: manipulation; }

        .side-nav-btn { position: fixed; bottom: 40px; width: 45px; height: 45px; background: rgba(255,255,255,0.9); color: var(--primary); border: 1px solid var(--border); border-radius: 50%; display: none; align-items: center; justify-content: center; font-size: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); cursor: pointer; z-index: 150; transition: 0.3s; touch-action: manipulation; }
        .side-nav-btn:active { transform: scale(0.9); background: var(--primary); color: #fff; }
        .side-nav-btn.show { display: flex; }
        #prevPageBtn { left: 15px; }
        #nextPageBtn { right: 15px; }

        #rocket { position: fixed; right: 15px; bottom: -60px; width: 45px; height: 45px; background: var(--primary); color: #fff; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 4px 12px rgba(255,102,153,0.4); cursor: pointer; transition: 0.4s; z-index: 200; font-size: 22px; touch-action: manipulation; }
        #rocket.show { bottom: 100px; }

        #adminBar { margin-top: 10px; display: none; gap: 10px; padding-top: 12px; border-top: 1px solid #eee; }
        #adminBar button { flex: 1; cursor: pointer; border: none; border-radius: 8px; padding: 12px; background: var(--primary); color: #fff; font-weight: bold; touch-action: manipulation; }
        .btn-save { background: #28a745 !important; }
        .btn-exit { background: #666 !important; }

        .del-btn, .pin-btn, .fav-btn { position: absolute; top: 10px; width: 28px; height: 28px; border-radius: 50%; display: none; justify-content: center; align-items: center; z-index: 20; cursor: pointer; color: #fff; font-size: 14px; touch-action: manipulation; }
        .del-btn { right: 10px; background: rgba(255,0,0,0.8); }
        .pin-btn { right: 45px; background: rgba(255,152,0,0.8); }
        .fav-btn { right: 80px; background: rgba(255,20,147,0.9); }
        .fav-btn.favorited { background: rgba(255,20,147,1); font-size: 16px; }
        .admin-mode .del-btn, .admin-mode .pin-btn { display: flex; }
        /* æ”¶è—æŒ‰é’®åœ¨éç®¡ç†å‘˜æ¨¡å¼ä¸‹ä¹Ÿæ˜¾ç¤º */
        .fav-btn { display: flex !important; }

        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-box { background: #fff; width: 85%; max-width: 350px; border-radius: 20px; padding: 25px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        .modal-title { font-size: 16px; font-weight: bold; color: #333; margin-bottom: 15px; }
        .modal-input { width: 100%; padding: 12px 0; border: none; border-bottom: 1px solid #eee; font-size: 15px; outline: none; margin-bottom: 25px; }
        .modal-btns { display: flex; gap: 15px; }
        .modal-btn { flex: 1; padding: 12px; border: none; border-radius: 12px; font-weight: bold; cursor: pointer; touch-action: manipulation; }
        .btn-cancel { background: #f5f5f5; color: #666; }
        .btn-confirm { background: #eff4ff; color: #3b82f6; }
    </style>
<style>
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    </style></head>
<body class="view-mode">

<div id="gateKeeper" style="display: flex;">
    <div class="gate-box">
        <h2 style="color:var(--primary)">å¤©ç¬‘ã®ç§˜å¯†åŸºåœ°</h2>
        <div class="disclaimer">
            <strong>ã€å…è´£å£°æ˜ã€‘</strong><br>
            æœ¬ç«™æ‰€æœ‰èµ„æºå‡æ”¶é›†è‡ªäº’è”ç½‘ï¼Œä»…ä¾›å­¦ä¹ å‚è€ƒä¸æŠ€æœ¯äº¤æµï¼Œä¸¥ç¦ç”¨äºä»»ä½•å•†ä¸šç”¨é€”ã€‚ä¸‹è½½åè¯·äº24å°æ—¶å†…åˆ é™¤ã€‚å› ç§è‡ªä¼ æ’­ã€å€’å–å¯¼è‡´çš„ä»»ä½•æ³•å¾‹çº çº·ä¸æœ¬ç«™æ— å…³ã€‚ç»§ç»­è®¿é—®å³ä»£è¡¨æ‚¨åŒæ„æœ¬åè®®ã€‚
        </div>
        <input type="password" id="accessPass" class="gate-input" placeholder="è¾“å…¥å¤©ç¬‘çš„è§£å‹æš—å·">
        <button class="gate-btn" onclick="verifyAccess()">è§£é”åŸºåœ°</button>
    </div>
</div>

<header>
    <div class="header-top">
        <div class="site-title">å¤©ç¬‘ã®ç§˜å¯†åŸºåœ°</div>
        <div id="entryBtn" class="login-icon" onclick="openLogin()" style="visibility: visible;">ğŸ”’</div>
    </div>
    <input type="text" id="search" placeholder="ğŸ” æœæœçœ‹..." oninput="refreshUI(1)">
    <div id="nav">
        <li class="notice-tab" onclick="filterTab('å…¬å‘Š',this)">ğŸ“¢ å…¬å‘Š</li>
        <li class="favorite-tab" onclick="filterTab('æ”¶è—',this)">ğŸ’– æˆ‘çš„æ”¶è—</li>
        <li class="active" onclick="filterTab('all',this)">ğŸŒŸ å…¨éƒ¨</li>
        <li onclick="filterTab('ACT',this)" class="">ACT</li>
        <li onclick="filterTab('SLG',this)" class="">SLG</li>
        <li onclick="filterTab('RPG',this)">RPG</li>
        <li onclick="filterTab('GAL',this)">GAL</li>
        <li onclick="filterTab('AZ',this)">AZ</li>
        <li onclick="filterTab('PC',this)">PC</li>
        <li onclick="filterTab('æœ¬å­',this)">ğŸ“š æœ¬å­</li>
        <li onclick="filterTab('å…¶ä»–è½¯ä»¶',this)">ğŸ› ï¸ å…¶ä»–è½¯ä»¶</li>
        <li onclick="filterTab('å……ç”µè§†é¢‘',this)" class="video-tab">âš¡ å……ç”µè§†é¢‘</li>
    </div>
    <div id="adminBar" style="display: none;">
        <button onclick="addCard()">â• æ–°å¢</button>
        <button class="btn-save" onclick="saveToGitHub()">â˜ï¸ ä¿å­˜äº‘ç«¯</button>
        <button onclick="clearCacheAndReload()" style="background: #ff9800 !important;">ğŸ”„ æ¸…ç¼“å­˜</button>
        <button class="btn-exit" onclick="exitAdmin()">ğŸšª é€€å‡º</button>
    </div>
</header>

<main id="mainScroll" onscroll="handleScroll()">
    <div class="grid" id="box"><div class="card active-render" data-card-id="card_1771284194677_nbmy3rka1" style="order: 0;">
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="active" loading="lazy" src="https://via.placeholder.com">
            <img loading="lazy" src="https://via.placeholder.com">
            <img loading="lazy" src="https://via.placeholder.com">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">1 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">æ ‡é¢˜...</div>
            <div class="g-tags">æ ‡ç­¾: ACT</div>
            <div class="link-wrap">
                <div class="link-text">ğŸ”— é“¾æ¥åŠç®€ä»‹...</div>
                <div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€ â–¾</div>
            </div>
        </div>
    </div><div class="card active-render" style="order: 1;" data-card-id="card_1771284173942_0">
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="active" loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzdpkEYUF6cM2Jr85ZBieEMAASJ0yTkAAu4LaxuvV4BEDZGywkv2XZ4BAAMCAANtAAM6BA.jpeg">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzZpkEXvtqDLGP9BfjEj5HcHIGCCVgAC7QtrG69XgEQ-YLy651zIUQEAAwIAA3gAAzoE.jpg" class="">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzhpkEYvWdGnGUb1D5T-gi4Ya6AKZAAC7wtrG69XgETLlj04eJmpiQEAAwIAA3cAAzoE.jpg" class="">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">1 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">ã€A6ã€‘Lessonï¼ˆ130MBï¼‰</div>
            <div class="g-tags">æ ‡ç­¾: å®‰å“ åƒç´  åŠ¨æ€ èè‰ ä½“æ“æœ</div>
            <div class="link-wrap">
                <div class="link-text">åˆ†å·1<div>https://pan.quark.cn/s/cOc54193691f</div><div>æå–ç :eR1q</div><div>åˆ†å·2</div><div>https://pan.quark.cn/s/681732cÑ6502</div><div>æå–ç :M7r2</div><div><br></div><div>è§£å‹ç :114514</div></div>
                <div class="link-actions"><button class="link-jump-btn" onclick="showLinkSelector([&quot;https://pan.quark.cn/s/cOc54193691f&quot;,&quot;https://pan.quark.cn/s/681732cÑ6502&quot;])">ğŸ”— é€‰æ‹©é“¾æ¥ (2ä¸ª)</button></div><div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€ â–¾</div>
            </div>
        </div>
    </div><div class="card active-render" style="order: 2;" data-card-id="card_1771284173942_1">
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="active" loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzNpkENj0Aiwyp6MPz5duaJBSB9eUwAC6AtrG69XgETUUtjXL2PJfQEAAwIAA3kAAzoE.jpg">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzRpkEN2Xm-WRFusvtFaom8HskzCEQAC6QtrG69XgESEsWkVU5NkNwEAAwIAA3kAAzoE.jpg" class="">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzVpkEOWvtMIVoA4zHIYdaJULlWbyQAC6gtrG69XgEQOvkhpIYUvRgEAAwIAA3kAAzoE.jpg" class="">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">1 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">ã€A5ã€‘å­™ç¬‘å·ä¼ å¥‡ï¼ˆ270MBï¼‰</div>
            <div class="g-tags">æ ‡ç­¾: å®‰å“ RPG çŒå¥‡</div>
            <div class="link-wrap">
                <div class="link-text">https://pan.quark.cn/s/4c1788ee28e4?pwd=kfjb<div>æå–ç :kfjb</div></div>
                <div class="link-actions"><button class="link-jump-btn" onclick="window.open('https://pan.quark.cn/s/4c1788ee28e4?pwd=kfjb', '_blank')">ğŸ”— æ‰“å¼€é“¾æ¥</button></div><div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€ â–¾</div>
            </div>
        </div>
    </div><div class="card active-render" style="order: 3;" data-card-id="card_1771284173942_2">
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="active" loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZy9pkEIEUaiSrjnNMj0RDcJcl7zS0AAC4wtrG69XgERCZbLBl-KeLQEAAwIAA3gAAzoE.webp">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzBpkEIXB6ivQIYZrANxPB-zs7ZTGwAC5AtrG69XgERj5z3-uMFzvAEAAwIAA3gAAzoE.webp" class="">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZzFpkEIs2Aof654RXR90sz3XLbBwqgAC5QtrG69XgESg24IZkAxbCAEAAwIAA3gAAzoE.webp" class="">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">1 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">ã€A4ã€‘kyuuko9ï¼ˆ40MBï¼‰</div>
            <div class="g-tags">æ ‡ç­¾: PC åƒç´  åŠ¨æ€ èè‰ SLG</div>
            <div class="link-wrap">
                <div class="link-text">https://pan.quark.cn/s/92010f612c22?pwd=pa2V<div>æå–ç ï¼špa2V</div></div>
                <div class="link-actions"><button class="link-jump-btn" onclick="window.open('https://pan.quark.cn/s/92010f612c22?pwd=pa2V', '_blank')">ğŸ”— æ‰“å¼€é“¾æ¥</button></div><div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€ â–¾</div>
            </div>
        </div>
    </div><div class="card active-render" style="order: 4;" data-card-id="card_1771284173942_3">
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="active" loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZyxpkD9UZ-aFW_EYmu6LHMoYp6ldlwAC4AtrG69XgES9V59981NhZQEAAwIAA3gAAzoE.jpg">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZy1pkD-ApJM4F41QqWYZMngKm5vh1AAC4QtrG69XgERW6iGi_ELpcQEAAwIAA3kAAzoE.jpg" class="">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZy5pkD-fRBgztq5BYqfjpKnSzsFcggAC4gtrG69XgES1Pq1W2UKvAwEAAwIAA3kAAzoE.jpg" class="">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">1 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">ã€A3ã€‘ä»¤å’Œæ—¶ä»£çš„èè‰æ§ï¼ˆ1.4Gï¼‰</div>
            <div class="g-tags">æ ‡ç­¾: PC RPG åƒç´  åŠ¨æ€ èè‰</div>
            <div class="link-wrap">
                <div class="link-text">https:/pan.quark.cn/s/2fa0472ac5af?pwd=eQVB<div>æå–ç :eQVB</div></div>
                <div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€ â–¾</div>
            </div>
        </div>
    </div><div class="card active-render" style="order: 5;" data-card-id="card_1771284173942_4">
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="active" loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZylpkD5mggQwEfzNdnEEotWd2xkxWgAC2wtrG69XgETCS3qv0rQX0AEAAwIAA3cAAzoE.jpg">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZyppkD5-GeiDjv0zfZnnQzd1UyWzpwAC3AtrG69XgEQn-ej4uB_CvAEAAwIAA3kAAzoE.jpg" class="">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZytpkD6Rx4cdUPVuO0_oeUCZ7jk4RgAC3QtrG69XgERV4rjMis_APQEAAwIAA3kAAzoE.jpg" class="">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">1 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">ã€A2ã€‘æˆ‘çš„å¥³ä»† /åƒ•ã®ãƒ¡ã‚¤ãƒ‰ï¼ˆ1.2Gï¼‰</div>
            <div class="g-tags">æ ‡ç­¾: PC å…»æˆ åƒç´  åŠ¨æ€ å¥³ä»† èè‰ SLG</div>
            <div class="link-wrap">
                <div class="link-text">https://pan.quark.cn/s/da3ab6a11c08<div>æå–ç :2X4x</div></div>
                <div class="link-actions"><button class="link-jump-btn" onclick="window.open('https://pan.quark.cn/s/da3ab6a11c08', '_blank')">ğŸ”— æ‰“å¼€é“¾æ¥</button></div><div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€ â–¾</div>
            </div>
        </div>
    </div><div class="card active-render" style="order: 6;" data-card-id="card_1771284173942_5">
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="" loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZyVpkDxeceHPBhLidF7zIfk9wglL2wAC2AtrG69XgES2fGjF3twC4wEAAwIAA3gAAzoE.jpg">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZydpkDyQSoXE-1jSHv2f8h_6uCZ9sgAC2QtrG69XgER6s-TT_E82oAEAAwIAA3gAAzoE.jpg" class="">
            <img loading="lazy" src="https://im.gurl.eu.org/file/AgACAgEAAxkDAAEBZyhpkDypRDekWEHSu1w3kzKVoMxiYwAC2gtrG69XgEQCFlepvQcKXgEAAwIAA3gAAzoE.jpg" class="active">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">3 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">ã€A1ã€‘æˆ‘å’Œå§å§ä»¬çš„å¤å¤©ï¼ˆ180MBï¼‰</div>
            <div class="g-tags">æ ‡ç­¾: PC RPG æ­£å¤ª éª‘å¤§è½¦ å·¨ä¹³ åƒç´  åŠ¨æ€</div>
            <div class="link-wrap expanded">
                <div class="link-text">åˆ†å·1<div>https://pan.quark.cn/s/f72479580e14?pwd=74QB</div><div>æå–ç :74QB</div><div>åˆ†å·2</div><div>https://pan.quark.cn/s/13e6ba4d007f?pwd=z4yN</div><div>æå–ç :z4yN</div></div>
                <div class="link-actions"><button class="link-jump-btn" onclick="showLinkSelector([&quot;https://pan.quark.cn/s/f72479580e14?pwd=74QB&quot;,&quot;https://pan.quark.cn/s/13e6ba4d007f?pwd=z4yN&quot;])">ğŸ”— é€‰æ‹©é“¾æ¥ (2ä¸ª)</button></div><div class="expand-btn" onclick="toggleExpand(this)">æ”¶èµ· â–´</div>
            </div>
        </div>
    </div></div>
    <div id="pagination" class="pagination"></div>
    <div id="rocket" onclick="goTop()" class="">ğŸš€</div>
    <div id="prevPageBtn" class="side-nav-btn" onclick="navPage(-1)">â€¹</div>
    <div id="nextPageBtn" class="side-nav-btn" onclick="navPage(1)">â€º</div>
</main>

<div id="loginModal" class="modal-overlay" style="display: none;">
    <div class="modal-box">
        <div class="modal-title">ğŸ”‘ éªŒè¯ç®¡ç†èº«ä»½ï¼š</div>
        <input type="password" id="passInput" class="modal-input" placeholder="å¤©ç¬‘çš„ç®¡ç†æš—å·">
        <div class="modal-btns">
            <button class="modal-btn btn-cancel" onclick="closeLogin()">å–æ¶ˆ</button>
            <button class="modal-btn btn-confirm" onclick="checkPass()">ç¡®å®š</button>
        </div>
    </div>
</div>

<script>
// ===== ğŸ›¡ï¸ ç»ˆæé˜²ä¸‹æ‹‰åˆ·æ–° =====
(function() {
    // 1. æœ€æ—©æœŸé˜»æ­¢ï¼šåœ¨ä»»ä½•æ¡†æ¶åŠ è½½å‰å°±æ‹¦æˆª
    let startY = 0;
    let startX = 0;

    document.addEventListener('touchstart', function(e) {
        startY = e.touches[0].pageY;
        startX = e.touches[0].pageX;
    }, { passive: true });

    document.addEventListener('touchmove', function(e) {
        const dy = e.touches[0].pageY - startY;
        const dx = e.touches[0].pageX - startX;
        const main = document.getElementById('mainScroll');

        // å¦‚æœæ˜¯æ¨ªå‘æ»‘åŠ¨ï¼Œä¸å¹²é¢„
        if (Math.abs(dx) > Math.abs(dy)) return;

        // è·å–å½“å‰æ»šåŠ¨å®¹å™¨
        const target = e.target.closest('#mainScroll') || e.target.closest('#nav');

        if (target === main) {
            // åœ¨æ»šåŠ¨åŒºåŸŸå†…
            const atTop = main.scrollTop <= 0;
            const atBottom = main.scrollTop + main.clientHeight >= main.scrollHeight - 1;

            if (atTop && dy > 0) {
                // åœ¨é¡¶éƒ¨ä¸‹æ‹‰ â†’ æ­»æ­»é˜»æ­¢
                e.preventDefault();
                e.stopPropagation();
            } else if (atBottom && dy < 0) {
                // åœ¨åº•éƒ¨ä¸Šæ‹‰ â†’ é˜»æ­¢è§¦å‘ç³»ç»Ÿåˆ·æ–°
                e.preventDefault();
                e.stopPropagation();
            }
        } else {
            // åœ¨éæ»šåŠ¨åŒºåŸŸï¼ˆheaderç­‰ï¼‰â†’ å…¨éƒ¨é˜»æ­¢
            e.preventDefault();
            e.stopPropagation();
        }
    }, { passive: false });

    // 2. é˜»æ­¢ overscroll
    document.addEventListener('scroll', function() {
        if (window.scrollY !== 0) window.scrollTo(0, 0);
    }, { passive: true });

    // 3. CSS æ–¹å¼å…œåº•ï¼ˆé€šè¿‡JSåŠ¨æ€æ³¨å…¥ï¼Œç¡®ä¿æœ€é«˜ä¼˜å…ˆçº§ï¼‰
    const style = document.createElement('style');
    style.textContent = `
        html, body {
            overscroll-behavior: none !important;
            overscroll-behavior-y: none !important;
            overflow: hidden !important;
            position: fixed !important;
            width: 100% !important;
            height: 100% !important;
        }
        #mainScroll {
            overscroll-behavior: contain !important;
            overscroll-behavior-y: contain !important;
            -webkit-overflow-scrolling: touch !important;
        }
    `;
    document.head.appendChild(style);
})();
// ================================

const ACCESS_PASS = "114514"; 
const ADMIN_PASS = "tianxiao"; 
const PAGE_SIZE = 10;
const FAV_KEY = "TX_FAVORITES";
const APP_VERSION = "1.0.0";
const VERSION_KEY = "TX_APP_VERSION";

// ===== GitHub äº‘ç«¯é…ç½® =====
const GH_USER  = "2865036763a-eng";
const GH_REPO  = "tianxiao-app";
const GH_FILE  = "data.json";          // å­˜æ•°æ®çš„æ–‡ä»¶å
const GH_TOKEN = "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";
const GH_API   = `https://api.github.com/repos/${GH_USER}/${GH_REPO}/contents/${GH_FILE}`;
// ===========================

let isEditMode = false;
let currentCat = "all";
let currentPage = 1;
let maxPageCount = 1;
let favorites = new Set(); // æ”¶è—åˆ—è¡¨ï¼ˆå­˜å‚¨å¡ç‰‡IDï¼‰

// æ£€æŸ¥ç‰ˆæœ¬æ›´æ–°
function checkForUpdates() {
    const savedVersion = localStorage.getItem(VERSION_KEY);
    
    if (!savedVersion) {
        // é¦–æ¬¡å®‰è£…
        localStorage.setItem(VERSION_KEY, APP_VERSION);
        console.log('âœ… é¦–æ¬¡å®‰è£…ï¼Œç‰ˆæœ¬:', APP_VERSION);
        return;
    }
    
    if (savedVersion !== APP_VERSION) {
        // æ£€æµ‹åˆ°æ–°ç‰ˆæœ¬
        console.log('ğŸ”„ æ£€æµ‹åˆ°æ›´æ–°:', savedVersion, 'â†’', APP_VERSION);
        showUpdateNotification(savedVersion, APP_VERSION);
        localStorage.setItem(VERSION_KEY, APP_VERSION);
    }
}

// æ˜¾ç¤ºæ›´æ–°é€šçŸ¥
function showUpdateNotification(oldVer, newVer) {
    const notification = document.createElement('div');
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 25px;
        border-radius: 12px;
        box-shadow: 0 8px 20px rgba(0,0,0,0.3);
        z-index: 9999;
        font-size: 14px;
        font-weight: bold;
        animation: slideDown 0.5s ease;
    `;
    notification.innerHTML = `
        ğŸ‰ åº”ç”¨å·²æ›´æ–°ï¼
        <span style="opacity: 0.8; font-size: 12px; margin-left: 8px;">
        ${oldVer} â†’ ${newVer}
        </span>
    `;
    document.body.appendChild(notification);
    
    // æ·»åŠ åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
        @keyframes slideDown {
            from { top: -100px; opacity: 0; }
            to { top: 20px; opacity: 1; }
        }
    `;
    document.head.appendChild(style);
    
    // 5ç§’åè‡ªåŠ¨æ¶ˆå¤±
    setTimeout(() => {
        notification.style.animation = 'slideDown 0.5s ease reverse';
        setTimeout(() => notification.remove(), 500);
    }, 5000);
}

// å¼ºåˆ¶åˆ·æ–°ç¼“å­˜
function clearCacheAndReload() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.getRegistrations().then(function(registrations) {
            for(let registration of registrations) {
                registration.unregister();
            }
        });
    }
    
    if ('caches' in window) {
        caches.keys().then(function(names) {
            for (let name of names) caches.delete(name);
        });
    }
    
    alert('âœ… ç¼“å­˜å·²æ¸…é™¤ï¼é¡µé¢å³å°†åˆ·æ–°');
    location.reload(true);
}

// ===== äº‘ç«¯è¯»å†™æ ¸å¿ƒå‡½æ•° =====

// ä» GitHub è¯»å–å¡ç‰‡æ•°æ®
async function loadFromGrave() {
    // å°è¯•ä»äº‘ç«¯åŠ è½½ï¼Œä½†è®¾ç½®è¶…æ—¶ä¿æŠ¤
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 3000); // 3ç§’è¶…æ—¶

    try {
        const res = await fetch(GH_API + "?t=" + Date.now(), {
            headers: { Authorization: "token " + GH_TOKEN },
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (res.ok) {
            const json = await res.json();
            // ä¿®å¤ä¸­æ–‡è§£ç ï¼šä½¿ç”¨TextDecoderå¤„ç†UTF-8
            const bytes = Uint8Array.from(atob(json.content.replace(/\n/g, "")), c => c.charCodeAt(0));
            const content = JSON.parse(new TextDecoder().decode(bytes));
            if (content.cards) {
                document.getElementById("box").innerHTML = content.cards;
            }
            window._ghSha = json.sha;
            console.log("âœ… äº‘ç«¯æ•°æ®å·²åŒæ­¥");
        } else if (res.status === 404) {
            // æ–‡ä»¶ä¸å­˜åœ¨ï¼Œä½¿ç”¨HTMLé»˜è®¤å†…å®¹
            window._ghSha = null;
            console.log("âœ… ä½¿ç”¨é»˜è®¤å†…å®¹");
        } else {
            throw new Error("HTTP " + res.status);
        }
    } catch(e) {
        clearTimeout(timeoutId);
        console.log("âš ï¸ äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ•°æ®:", e.message);
        // ä¸æ˜¾ç¤ºToastï¼Œé™é»˜å›é€€åˆ°æœ¬åœ°
        // ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ç¼“å­˜ï¼Œå…¶æ¬¡ä½¿ç”¨HTMLå†…åµŒå†…å®¹
        const cached = localStorage.getItem("TX_CACHE");
        if (cached) {
            document.getElementById("box").innerHTML = cached;
        }
        // å¦‚æœæœ¬åœ°ç¼“å­˜ä¹Ÿæ²¡æœ‰ï¼ŒHTMLé‡Œå·²ç»æœ‰é»˜è®¤å¡ç‰‡äº†ï¼Œä»€ä¹ˆéƒ½ä¸åš
    }

    // åŠ è½½æ”¶è—ï¼ˆæ”¶è—æ˜¯æœ¬åœ°çš„ï¼Œä¸ç”¨äº‘ç«¯ï¼‰
    const savedFav = localStorage.getItem(FAV_KEY);
    if (savedFav) {
        try { favorites = new Set(JSON.parse(savedFav)); } catch(e) { favorites = new Set(); }
    }
    initCardFavorites();
    refreshUI();
}

// ä¿å­˜å¡ç‰‡æ•°æ®åˆ° GitHub
async function saveToGitHub() {
    const cards = document.getElementById("box").innerHTML;
    const payload = JSON.stringify({ cards, updated: new Date().toISOString() });
    
    // ä¿®å¤ä¸­æ–‡ç¼–ç ï¼šä½¿ç”¨TextEncoderè½¬ä¸ºUTF-8å†base64
    const encoded = btoa(String.fromCharCode(...new TextEncoder().encode(payload)));

    const body = {
        message: "ğŸ“¦ æ›´æ–°èµ„æºåº“ " + new Date().toLocaleString("zh-CN"),
        content: encoded
    };
    if (window._ghSha) body.sha = window._ghSha;

    showToast("â³ æ­£åœ¨ä¿å­˜åˆ°äº‘ç«¯...", 0);
    
    // è®¾ç½®5ç§’è¶…æ—¶
    const controller = new AbortController();
    const timeoutId = setTimeout(() => controller.abort(), 5000);
    
    try {
        const res = await fetch(GH_API, {
            method: "PUT",
            headers: {
                Authorization: "token " + GH_TOKEN,
                "Content-Type": "application/json"
            },
            body: JSON.stringify(body),
            signal: controller.signal
        });
        clearTimeout(timeoutId);
        
        if (res.ok) {
            const json = await res.json();
            window._ghSha = json.content.sha;
            localStorage.setItem("TX_CACHE", cards);
            showToast("âœ… å·²åŒæ­¥åˆ°äº‘ç«¯ï¼æ‰€æœ‰äººå°†çœ‹åˆ°æœ€æ–°å†…å®¹");
        } else {
            const err = await res.json();
            throw new Error(err.message);
        }
    } catch(e) {
        clearTimeout(timeoutId);
        // å³ä½¿äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œä¹Ÿä¿å­˜åˆ°æœ¬åœ°
        localStorage.setItem("TX_CACHE", cards);
        
        if (e.name === 'AbortError') {
            showToast("âš ï¸ ç½‘ç»œè¶…æ—¶ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°");
        } else {
            showToast("âš ï¸ äº‘ç«¯ä¿å­˜å¤±è´¥ï¼Œå·²ä¿å­˜åˆ°æœ¬åœ°");
        }
        console.warn("GitHubä¿å­˜å¤±è´¥:", e);
    }
}

// æœ¬åœ°è‡ªåŠ¨ç¼“å­˜ï¼ˆä¸ä¸Šä¼ ï¼Œç”¨äºé˜²ä¸¢å¤±ï¼‰
function autoSave() {
    const data = document.getElementById("box").innerHTML;
    localStorage.setItem("TX_CACHE", data);
}

// é€šç”¨Toastæç¤º
let _toastTimer = null;
function showToast(msg, duration = 2500) {
    let toast = document.getElementById("_ghToast");
    if (!toast) {
        toast = document.createElement("div");
        toast.id = "_ghToast";
        toast.style.cssText = `
            position:fixed;top:20px;left:50%;transform:translateX(-50%);
            background:rgba(30,30,30,0.92);color:#fff;padding:10px 22px;
            border-radius:20px;font-size:13px;z-index:9999;
            box-shadow:0 4px 15px rgba(0,0,0,0.3);transition:opacity 0.3s;
            white-space:nowrap;pointer-events:none;
        `;
        document.body.appendChild(toast);
    }
    toast.textContent = msg;
    toast.style.opacity = "1";
    if (_toastTimer) clearTimeout(_toastTimer);
    if (duration > 0) {
        _toastTimer = setTimeout(() => { toast.style.opacity = "0"; }, duration);
    }
}

function refreshUI(targetPage) {
    if(targetPage) {
        currentPage = targetPage;
        goTop();
    }
    const searchVal = document.getElementById("search").value.toUpperCase();
    const box = document.getElementById("box");
    const allCards = Array.from(box.querySelectorAll(".card"));
    
    // 1. è¿‡æ»¤é€»è¾‘
    let filtered = allCards.filter(c => {
        const txt = c.innerText.toUpperCase();
        const matchCat = (currentCat === "all" || txt.includes(currentCat));
        const matchSearch = txt.includes(searchVal);
        
        // æ”¶è—åˆ†åŒºï¼šåªæ˜¾ç¤ºå·²æ”¶è—çš„å¡ç‰‡
        if (currentCat === 'æ”¶è—') {
            const cardId = c.dataset.cardId;
            return cardId && favorites.has(cardId) && matchSearch;
        }
        
        return matchCat && matchSearch;
    });

    // 2. âœ¨ æ ¸å¿ƒæ’åºä¿®å¤ï¼šä½¿ç”¨ Array.sort é‡æ–°ç¡®å®šæ•°ç»„é¡ºåº
    filtered.sort((a, b) => {
        const aP = a.classList.contains("is-pinned") ? 1 : 0;
        const bP = b.classList.contains("is-pinned") ? 1 : 0;
        return bP - aP; // ç½®é¡¶æƒé‡æœ€é«˜
    });

    // 3. âœ¨ å…³é”®æ­¥éª¤ï¼šæ ¹æ®æ’åºç»“æœï¼ŒåŠ¨æ€ç»™ DOM å…ƒç´ åˆ†é… order æƒé‡
    // å¼ºåˆ¶ç½®é¡¶çš„ order ä¸ºæå°å€¼ï¼Œæ™®é€šå¡ç‰‡æŒ‰ç…§å®ƒä»¬åœ¨æ•°ç»„ä¸­çš„é¡ºåºåˆ†é…é€’å¢çš„ order
    filtered.forEach((card, index) => {
        if (card.classList.contains("is-pinned")) {
            card.style.order = "-1000"; // ç»å¯¹ç½®é¡¶
        } else {
            card.style.order = index; // ä¿æŒè¿‡æ»¤åçš„è‡ªç„¶é¡ºåº
        }
    });

    allCards.forEach(c => c.classList.remove("active-render"));
    const pagContainer = document.getElementById("pagination");
    maxPageCount = Math.ceil(filtered.length / PAGE_SIZE);
    
    if(currentPage > maxPageCount && maxPageCount > 0) currentPage = maxPageCount;

    const start = (currentPage - 1) * PAGE_SIZE;
    filtered.slice(start, start + PAGE_SIZE).forEach(c => c.classList.add("active-render"));

    document.getElementById("prevPageBtn").classList.toggle("show", currentPage > 1);
    document.getElementById("nextPageBtn").classList.toggle("show", currentPage < maxPageCount);

    pagContainer.innerHTML = "";
    if (maxPageCount > 1) {
        let numHtml = `<div class="page-numbers">`;
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(maxPageCount, startPage + 4);
        if (endPage === maxPageCount) startPage = Math.max(1, maxPageCount - 4);
        
        if (startPage > 1) {
            numHtml += `<div class="page-item" onclick="refreshUI(1)">1</div>`;
            if (startPage > 2) numHtml += `<div class="page-dot">...</div>`;
        }
        for (let i = startPage; i <= endPage; i++) {
            numHtml += `<div class="page-item ${i === currentPage ? 'active' : ''}" onclick="refreshUI(${i})">${i}</div>`;
        }
        if (endPage < maxPageCount) {
            if (endPage < maxPageCount - 1) numHtml += `<div class="page-dot">...</div>`;
            numHtml += `<div class="page-item" onclick="refreshUI(${maxPageCount})">${maxPageCount}</div>`;
        }
        numHtml += `</div>`;

        let funcHtml = `
            <div class="page-jump-row">
                <span>è·³è‡³</span>
                <input type="number" class="page-jump" placeholder="é¡µç ..." onkeydown="if(event.keyCode==13) { let p=parseInt(this.value); if(p>0 && p<=${maxPageCount}) refreshUI(p); else alert('æ²¡æœ‰è¿™ä¸€é¡µï¼'); }">
                <span>/ å…± ${maxPageCount} é¡µ</span>
            </div>`;

        pagContainer.innerHTML = numHtml + funcHtml;
    }

    if(isEditMode) autoSave();
    
    // ğŸ”— ä¸ºæ‰€æœ‰link-wrapæ·»åŠ è·³è½¬æŒ‰é’®
    addLinkJumpButtons();
}

function navPage(dir) {
    let target = currentPage + dir;
    if(target >= 1 && target <= maxPageCount) refreshUI(target);
}

function verifyAccess() {
    if(document.getElementById("accessPass").value === ACCESS_PASS) document.getElementById("gateKeeper").style.display = "none";
    else alert("ä½ å¥½åƒä¸æ˜¯è‡ªå·±äººï¼Œè‡ªç”±ä¹‹åœ°ä¸æ¬¢è¿ä½ â™‚");
}

function filterTab(cat, el) {
    document.querySelectorAll("#nav li").forEach(li => li.classList.remove("active"));
    el.classList.add("active");
    currentCat = cat;
    refreshUI(1); 
}

function handleScroll() {
    const main = document.getElementById("mainScroll");
    const rocket = document.getElementById("rocket");
    if (main.scrollTop > 300) rocket.classList.add("show");
    else rocket.classList.remove("show");
}

function goTop() { document.getElementById("mainScroll").scrollTo({ top: 0, behavior: 'smooth' }); }

function openLogin() { if(!isEditMode) document.getElementById("loginModal").style.display = "flex"; }
function closeLogin() { document.getElementById("loginModal").style.display = "none"; document.getElementById("passInput").value = ""; }
function checkPass() {
    if(document.getElementById("passInput").value === ADMIN_PASS) { enterAdmin(); closeLogin(); }
    else { alert("ä½ è¿˜æƒ³å†’å……å¤©ç¬‘æˆ‘?å»é¹¿å§ä½ ï¼"); closeLogin(); }
}

function enterAdmin() {
    isEditMode = true; 
    document.body.classList.add("admin-mode");
    document.getElementById("adminBar").style.display = "flex";
    document.getElementById("entryBtn").style.visibility = "hidden";
    
    document.querySelectorAll(".card").forEach(card => {
        if (!card.querySelector(".pin-btn")) {
            const pin = document.createElement("div");
            pin.className = "pin-btn";
            pin.innerHTML = "ğŸ“Œ";
            pin.onclick = function() { togglePin(this); };
            card.prepend(pin);
        }
        const delBtn = card.querySelector(".del-btn");
        if (delBtn) delBtn.onclick = function() { deleteCard(this); };
    });

    document.querySelectorAll(".g-name, .g-tags, .link-text").forEach(el => el.contentEditable = "true");
    refreshUI();
}

function exitAdmin() {
    isEditMode = false; document.body.classList.remove("admin-mode");
    document.getElementById("adminBar").style.display = "none";
    document.getElementById("entryBtn").style.visibility = "visible";
    document.querySelectorAll(".g-name, .g-tags, .link-text").forEach(el => {
        el.contentEditable = "false";
        el.removeAttribute("contenteditable");
    });
    autoSave();
    refreshUI();
    if (confirm("ğŸ“¤ æ˜¯å¦å°†ä¿®æ”¹åŒæ­¥åˆ°äº‘ç«¯ï¼Ÿ\nï¼ˆæ‰€æœ‰ç”¨æˆ·å°†çœ‹åˆ°æœ€æ–°å†…å®¹ï¼‰")) {
        saveToGitHub();
    }
}

function togglePin(btn) {
    const card = btn.parentElement;
    card.classList.toggle("is-pinned");
    // âœ¨ æ ¸å¿ƒä¿®å¤ï¼šç‚¹å‡»ç½®é¡¶åç«‹åˆ»é‡æ’ order æƒé‡
    refreshUI();
    autoSave();
}

function deleteCard(btn) {
    const card = btn.parentElement;
    const cardName = card.querySelector('.g-name').innerText;
    if (confirm(`âš ï¸ ç¡®å®šè¦åˆ é™¤èµ„æºã€${cardName}ã€‘å—ï¼Ÿ`)) {
        card.remove();
        alert("âœ… å·²æˆåŠŸåˆ é™¤ï¼");
        refreshUI();
        autoSave();
    }
}

function addCard() {
    const div = document.createElement("div");
    div.className = "card";
    let defaultTag = currentCat === 'all' ? 'ACT' : currentCat;
    
    div.innerHTML = `
        <div class="pin-btn" onclick="togglePin(this)">ğŸ“Œ</div>
        <div class="del-btn" onclick="deleteCard(this)">Ã—</div>
        <div class="slider-box">
            <button class="edit-img-btn" onclick="editCurrentImg(this)">ğŸ”— æ›´æ¢å›¾ç‰‡</button>
            <button class="slide-btn prev" onclick="changeSlide(this, -1)">â€¹</button>
            <img class="active" loading="lazy" src="https://via.placeholder.com">
            <img loading="lazy" src="https://via.placeholder.com">
            <img loading="lazy" src="https://via.placeholder.com">
            <button class="slide-btn next" onclick="changeSlide(this, 1)">â€º</button>
            <div class="img-index">1 / 3</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
            <div class="fav-btn" onclick="toggleFavorite(this)">ğŸ¤</div>
        </div>
        <div class="info-box">
            <div class="g-name">æ ‡é¢˜...</div>
            <div class="g-tags">æ ‡ç­¾: ${defaultTag}</div>
            <div class="link-wrap">
                <div class="link-text">ğŸ”— é“¾æ¥åŠç®€ä»‹...</div>
                <div class="expand-btn" onclick="toggleExpand(this)">å±•å¼€ â–¾</div>
            </div>
        </div>
    `;
    // ç‰©ç†æ’å…¥ä½ç½®ä¸é‡è¦äº†ï¼Œå› ä¸º refreshUI ä¼šé  order å¼ºåˆ¶ä¿®æ­£ä½ç½®
    document.getElementById("box").prepend(div);
    
    // ä¸ºæ–°å¡ç‰‡åˆ†é…ID
    div.dataset.cardId = 'card_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
    
    // ğŸ”’ å®‰å…¨ä¿®å¤ï¼šä»…åœ¨ç®¡ç†å‘˜æ¨¡å¼ä¸‹è®¾ç½®ä¸ºå¯ç¼–è¾‘
    if (isEditMode) {
        div.querySelectorAll(".g-name, .g-tags, .link-text").forEach(el => el.contentEditable = "true");
    }
    
    document.getElementById("search").value = ""; 
    
    // âœ¨ æ ¸å¿ƒä¿®å¤ï¼šæ–°å¢åç«‹å³åˆ·æ–°ä»¥åº”ç”¨æœ€æ–°çš„ order æƒé‡
    refreshUI(1);
}

function changeSlide(btn, dir) {
    const box = btn.parentElement;
    const imgs = box.querySelectorAll('img');
    const indexTag = box.querySelector('.img-index');
    let idx = Array.from(imgs).findIndex(img => img.classList.contains('active'));
    imgs[idx].classList.remove('active');
    idx = (idx + dir + imgs.length) % imgs.length;
    imgs[idx].classList.add('active');
    indexTag.innerText = `${idx + 1} / ${imgs.length}`;
}

function editCurrentImg(btn) {
    const activeImg = btn.parentElement.querySelector('img.active');
    const url = prompt("ğŸ–¼ï¸ è¾“å…¥å›¾ç‰‡URL:", activeImg.src);
    if(url && url.startsWith('http')) {
        activeImg.src = url;
        autoSave();
    }
}

function toggleExpand(btn) {
    const wrap = btn.parentElement;
    wrap.classList.toggle('expanded');
    btn.innerText = wrap.classList.contains('expanded') ? "æ”¶èµ· â–´" : "å±•å¼€ â–¾";
}

// ğŸ’– æ”¶è—åŠŸèƒ½
function initCardFavorites() {
    const allCards = document.querySelectorAll('.card');
    allCards.forEach((card, index) => {
        // ä¸ºæ¯ä¸ªå¡ç‰‡åˆ†é…å”¯ä¸€IDï¼ˆå¦‚æœæ²¡æœ‰çš„è¯ï¼‰
        if (!card.dataset.cardId) {
            card.dataset.cardId = 'card_' + Date.now() + '_' + index;
        }
        
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰æ”¶è—æŒ‰é’®
        if (!card.querySelector('.fav-btn')) {
            const favBtn = document.createElement('div');
            favBtn.className = 'fav-btn';
            const cardId = card.dataset.cardId;
            favBtn.innerHTML = favorites.has(cardId) ? 'ğŸ’–' : 'ğŸ¤';
            if (favorites.has(cardId)) favBtn.classList.add('favorited');
            favBtn.onclick = function() { toggleFavorite(this); };
            
            // æ’å…¥åˆ°å¡ç‰‡é¡¶éƒ¨ï¼ˆåœ¨pinæŒ‰é’®ä¹‹åï¼‰
            const sliderBox = card.querySelector('.slider-box');
            if (sliderBox) {
                sliderBox.appendChild(favBtn);
            } else {
                card.prepend(favBtn);
            }
        }
    });
}

function toggleFavorite(btn) {
    const card = btn.closest('.card');
    const cardId = card.dataset.cardId;
    
    if (!cardId) return;
    
    if (favorites.has(cardId)) {
        // å–æ¶ˆæ”¶è—
        favorites.delete(cardId);
        btn.innerHTML = 'ğŸ¤';
        btn.classList.remove('favorited');
    } else {
        // æ·»åŠ æ”¶è—
        favorites.add(cardId);
        btn.innerHTML = 'ğŸ’–';
        btn.classList.add('favorited');
    }
    
    // ä¿å­˜æ”¶è—æ•°æ®
    saveFavorites();
    
    // å¦‚æœå½“å‰åœ¨æ”¶è—åˆ†åŒºï¼Œåˆ·æ–°æ˜¾ç¤º
    if (currentCat === 'æ”¶è—') {
        refreshUI();
    }
}

function saveFavorites() {
    localStorage.setItem(FAV_KEY, JSON.stringify([...favorites]));
}

// ğŸ”— ä¸ºæ‰€æœ‰å¡ç‰‡æ·»åŠ è·³è½¬æŒ‰é’®
function addLinkJumpButtons() {
    document.querySelectorAll('.link-wrap').forEach(wrap => {
        // æ£€æŸ¥æ˜¯å¦å·²æœ‰è·³è½¬æŒ‰é’®
        if (wrap.querySelector('.link-actions')) return;
        
        const linkText = wrap.querySelector('.link-text');
        const expandBtn = wrap.querySelector('.expand-btn');
        
        if (!linkText || !expandBtn) return;
        
        // æå–é“¾æ¥
        const text = linkText.innerText || linkText.textContent;
        const urls = extractUrls(text);
        
        if (urls.length === 0) return; // æ²¡æœ‰é“¾æ¥å°±ä¸æ·»åŠ æŒ‰é’®
        
        // åˆ›å»ºæŒ‰é’®å®¹å™¨
        const actionsDiv = document.createElement('div');
        actionsDiv.className = 'link-actions';
        
        if (urls.length === 1) {
            // å•ä¸ªé“¾æ¥ï¼šæ˜¾ç¤ºä¸€ä¸ªè·³è½¬æŒ‰é’®
            actionsDiv.innerHTML = `<button class="link-jump-btn" onclick="window.open('${urls[0]}', '_blank')">ğŸ”— æ‰“å¼€é“¾æ¥</button>`;
        } else {
            // å¤šä¸ªé“¾æ¥ï¼šæ˜¾ç¤ºé€‰æ‹©æŒ‰é’®
            const urlsJson = JSON.stringify(urls).replace(/'/g, "\\'");
            actionsDiv.innerHTML = `<button class="link-jump-btn" onclick='showLinkSelector(${urlsJson})'>ğŸ”— é€‰æ‹©é“¾æ¥ (${urls.length}ä¸ª)</button>`;
        }
        
        // æ’å…¥åˆ°å±•å¼€æŒ‰é’®ä¹‹å‰
        wrap.insertBefore(actionsDiv, expandBtn);
    });
}

// ä»æ–‡æœ¬ä¸­æå–æ‰€æœ‰URL
function extractUrls(text) {
    const urlPattern = /(https?:\/\/[^\s<>"]+)/g;
    const matches = text.match(urlPattern);
    if (!matches) return [];
    
    // æ¸…ç†URLæœ«å°¾çš„æ ‡ç‚¹
    return matches.map(url => {
        return url.replace(/[,ï¼Œã€‚.;ï¼›!ï¼?ï¼Ÿ\)ï¼‰\]ã€‘}>ã€‹\'"]+$/, '');
    });
}

// æ˜¾ç¤ºå¤šé“¾æ¥é€‰æ‹©å™¨
function showLinkSelector(urls) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.style.display = 'flex';
    
    let linksHtml = urls.map((url, idx) => {
        const shortUrl = url.length > 60 ? url.substring(0, 60) + '...' : url;
        return `<div style="margin: 8px 0;">
            <button class="modal-btn btn-confirm" onclick="window.open('${url}', '_blank'); this.closest('.modal-overlay').remove();" style="width: 100%; text-align: left; padding: 12px; word-break: break-all;">
                ${idx + 1}. ${shortUrl}
            </button>
        </div>`;
    }).join('');
    
    modal.innerHTML = `
        <div class="modal-box" style="max-width: 450px;">
            <div class="modal-title">ğŸ”— é€‰æ‹©è¦æ‰“å¼€çš„é“¾æ¥ (å…±${urls.length}ä¸ª)</div>
            <div style="max-height: 400px; overflow-y: auto;">
                ${linksHtml}
            </div>
            <div style="margin-top: 15px;">
                <button class="modal-btn btn-cancel" onclick="this.closest('.modal-overlay').remove()" style="width: 100%;">å–æ¶ˆ</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // ç‚¹å‡»èƒŒæ™¯å…³é—­
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

function savePage() {
    const was = isEditMode; exitAdmin();
    const gate = document.getElementById("gateKeeper");
    const wasGate = gate.style.display;
    gate.style.display = "flex"; 
    const clone = document.documentElement.cloneNode(true);
    clone.querySelector("#search").value = "";
    const blob = new Blob(["<!DOCTYPE html>\n" + clone.outerHTML], {type: "text/html"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "å¤©ç¬‘æ“ä½œç§˜å¯†åŸºåœ°.html";
    a.click();
    gate.style.display = wasGate;
    if(was) enterAdmin();
}

window.onload = async () => { 
    // ğŸ”„ æ£€æŸ¥ç‰ˆæœ¬æ›´æ–°ï¼ˆæœ€ä¼˜å…ˆï¼‰
    checkForUpdates();
    
    await loadFromGrave();
    // ğŸ”’ å®‰å…¨ä¿®å¤ï¼šé¡µé¢åŠ è½½æ—¶ç¡®ä¿éç®¡ç†å‘˜æ¨¡å¼ä¸‹æ‰€æœ‰å…ƒç´ ä¸å¯ç¼–è¾‘
    if (!isEditMode) {
        document.querySelectorAll(".g-name, .g-tags, .link-text").forEach(el => {
            el.contentEditable = "false";
            el.removeAttribute("contenteditable");
        });
    }
    
    // ğŸ“± æ³¨å†ŒService Workerï¼ˆPWAæ”¯æŒï¼‰
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register(createServiceWorkerBlob()).then(function(registration) {
            console.log('âœ… PWAå·²æ¿€æ´»ï¼å¯ä»¥æ·»åŠ åˆ°ä¸»å±å¹•äº†');
            
            // ç›‘å¬Service Workeræ›´æ–°
            registration.addEventListener('updatefound', () => {
                const newWorker = registration.installing;
                newWorker.addEventListener('statechange', () => {
                    if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                        // æœ‰æ–°ç‰ˆæœ¬å¯ç”¨
                        if (confirm('ğŸ‰ å‘ç°æ–°ç‰ˆæœ¬ï¼æ˜¯å¦ç«‹å³æ›´æ–°ï¼Ÿ')) {
                            newWorker.postMessage({ action: 'skipWaiting' });
                            window.location.reload();
                        }
                    }
                });
            });
        }).catch(function(err) {
            console.log('Service Workeræ³¨å†Œå¤±è´¥:', err);
        });
    }
    
    // æ˜¾ç¤ºå®‰è£…æç¤º
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        showInstallButton();
    });
};

// åˆ›å»ºå†…è”Service Worker
function createServiceWorkerBlob() {
    const swCode = `
        const CACHE_NAME = 'tianxiao-cache-v1';
        const urlsToCache = ['/'];
        
        self.addEventListener('install', event => {
            event.waitUntil(
                caches.open(CACHE_NAME).then(cache => cache.addAll(urlsToCache))
            );
        });
        
        self.addEventListener('fetch', event => {
            event.respondWith(
                caches.match(event.request).then(response => {
                    return response || fetch(event.request);
                })
            );
        });
    `;
    const blob = new Blob([swCode], { type: 'application/javascript' });
    return URL.createObjectURL(blob);
}

// æ˜¾ç¤ºå®‰è£…æŒ‰é’®
function showInstallButton() {
    // å¦‚æœå·²ç»åœ¨ä¸»å±å¹•ï¼Œä¸æ˜¾ç¤º
    if (window.matchMedia('(display-mode: standalone)').matches) return;
    
    const installBtn = document.createElement('div');
    installBtn.innerHTML = 'ğŸ“±';
    installBtn.style.cssText = `
        position: fixed;
        left: 15px;
        bottom: 100px;
        width: 45px;
        height: 45px;
        background: #4CAF50;
        color: #fff;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 22px;
        box-shadow: 0 4px 12px rgba(76,175,80,0.4);
        cursor: pointer;
        z-index: 200;
        animation: pulse 2s infinite;
    `;
    installBtn.title = 'æ·»åŠ åˆ°ä¸»å±å¹•';
    installBtn.onclick = installApp;
    document.body.appendChild(installBtn);
    
    // æ·»åŠ è„‰å†²åŠ¨ç”»
    const style = document.createElement('style');
    style.textContent = `
        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
    `;
    document.head.appendChild(style);
}

function installApp() {
    if (!window.deferredPrompt) {
        alert('ğŸ“± è¯·ç‚¹å‡»æµè§ˆå™¨èœå•ä¸­çš„"æ·»åŠ åˆ°ä¸»å±å¹•"é€‰é¡¹ï¼');
        return;
    }
    
    window.deferredPrompt.prompt();
    window.deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
            console.log('ç”¨æˆ·æ¥å—äº†å®‰è£…');
        }
        window.deferredPrompt = null;
    });
}

setInterval(() => { if(isEditMode) autoSave(); }, 5000);
</script>


<div title="æ·»åŠ åˆ°ä¸»å±å¹•" style="position: fixed; left: 15px; bottom: 100px; width: 45px; height: 45px; background: rgb(76, 175, 80); color: rgb(255, 255, 255); border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 22px; box-shadow: rgba(76, 175, 80, 0.4) 0px 4px 12px; cursor: pointer; z-index: 200; animation: 2s ease 0s infinite normal none running pulse;">ğŸ“±</div></body></html>
